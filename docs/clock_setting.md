## Описание файла `clockSetting.h`

- [Для чего он нужен?](#для-чего-он-нужен)
- [Блок "экран часов"](#блок-экран-часов)
  - [Экран LCD 1602/2004/2004](#экран-lcd-16022004)
  - [Матрица из адресных светодиодов](#матрица-из-адресных-светодиодов)
  - [Опции для матричных экранов](#опции-для-матричных-экранов)
- [Блок "кнопки"](#блок-кнопки)
- [Блок "дополнительные опции"](#блок-дополнительные-опции)
  - [Календарь](#календарь)
  - [Будильник](#будильник)
  - [Режим настройки уровней яркости](#режим-настройки-уровней-яркости)
  - [Вывод температуры](#вывод-температуры)
- [Блок "пищалка"](#блок-пищалка)
- [Блок "датчики"](#блок-датчики)
  - [Датчик освещенности](#датчик-освещенности)
  - [Датчики температуры](#датчики-температуры)
    - [DS18B20](#ds18b20)
    - [NTC термистор](#ntc-термистор)
- [Блок "прочие настройки"](#блок-прочие-настройки)
- [Блок "настройки EEPROM"](#блок-настройки-eeprom)
- [Блок "модуль RTC"](#блок-модуль-rtc)
- [Смотри так же](#смотри-так-же)

### Для чего он нужен?

Все базовые настройки часов, как то: используемые модули, используемый набор опций, пины для подключения периферии - задаются в файле **clockSetting.h**, который нужно поместить в папку со скетчем. Закомментировав ненужные опции и, наоборот, раскомментировав нужные, вы получите часы с нужным вам функционалом.

***Важно!!!** - объявление файла **clockSetting.h** в скетче должно быть **ДО** объявления библиотеки **shSimpleClock.h** (пример см. ниже):*

```
#include "clockSetting.h"
#include <shSimpleClock.h>
```

Образец файла [**clockSetting.h**](../clockSetting.h) идет вместе с библиотекой.

Файл разбит на блоки настроек. Поблочно и будем его описывать

### Блок "экран часов"

Строка
```
#define TM1637_DISPLAY
```
задает, какой экран используется часами. Библиотека позволяет использовать несколько типов экранов.

Всего возможны пять вариантов, все они описаны в комментарии к строке: 
- `TM1637_DISPLAY`
- `MAX72XX_7SEGMENT_DISPLAY`
- `MAX72XX_MATRIX_DISPLAY`
- `WS2812_MATRIX_DISPLAY`
- `LCD_I2C_DISPLAY     `

Для экранов на базе **TM1637** и **MAX7219**/**MAX7221** в этом блоке нужно указать только номера пинов, к которым будут подключаться экраны. При этом имейте в виду, что драйвера **MAX7219**/**MAX7221** работают через аппаратный **SPI** вашего микроконтроллера. 

#### Экран LCD 1602/2004/2004

Для текстовых **LCD** экранов нужно указать адрес устройства на шине **I2C**; адрес задается в строке 
```
constexpr uint8_t BUS_DISPLAY_ADDRESS = 0X27;
```
Строки
```
constexpr uint8_t NUMBER_OF_CHAR_PER_LINE = 16;
constexpr uint8_t NUMBER_OF_LINE_PER_DISPLAY = 2;
```
определяют количество символов на строку и количество строк на экране соответственно;

Строки
```
constexpr uint8_t FIRST_LINE_NUMBER = 0;
constexpr uint8_t SECOND_LINE_NUMBER = 1;
``` 
определяют номера строк дисплея для вывода данных часов - для вывода верхних и нижних частей цифр; значения, отличные от 0 и 1 нужно задавать для четырехстрочных экранов;

В строке 
```
constexpr uint8_t OFFSET_FOR_FIRST_CHAR = 0;
```
задается смещение первого символа от левого края экрана; задавать величину, отличную от нуля имеет смысл для экранов с количеством символов на строку больше 16;

Номера пинов соответствуют номерам пинов аппаратного **I2C** МК и приведены только для информации;

#### Матрица из адресных светодиодов

Строка
```
#define CHIPSET_WS2812B
```
определяет, какой чип используется в адресных светодиодах матрицы. Возможных вариантов много, поддерживаемые чипы перечислены в комментарии к строке.

Второй важный параметр - очередность следования цветов в чипе, задается в строке
```
#define EORDER GRB
```
Определить нужный порядок просто - если вы, например, указали порядок следования **RGB**, задали цвет символов **CRGB::Red** (красный цвет), а цифры на экране рисуются зеленым, попробуйте поменять порядок следования на **GRB**.

Если вы используете адресные светодиоды с четырехпроводной схемой подключения и хотите подключить их к аппаратному **SPI** вашего микроконтроллера, раскомментируйте строку
```
#define USE_HARDWARE_SPI
```
В этом случае указывать номера пинов для подключения матрицы в файле **clockSetting.h** не нужно.

Далее указывается порядок построения матрицы, который задается в строке
```
#define MX_TYPE BY_COLUMNS
```
Матрица может быть построена как построчно (`BY_LINE`), так и по столбцам (`BY_COLUMNS`); начальная точка - верхний левый пиксель.

Строки
```
#define COLOR_OF_NUMBER CRGB::Red
```
и
```
#define COLOR_OF_BACKGROUND CRGB::Black
```
задают цвета символов и фона матрицы соответственно. Так же эти параметры можно менять программно в процессе выполнения программы.

Строки
```
uint32_t constexpr POWER_SUPPLY_VOLTAGE = 5;
```
и
```
uint32_t constexpr POWER_SUPPLY_CURRENT = 2000;
```
задают параметры блока питания матрицы - напряжение в вольтах и максимальную силу тока в милиамперах. Эти параметры позволяют уберечь блок питания от перегрузки и выхода из строя.

Далее указывается пин/пины для подключения матрицы.

#### Опции для матричных экранов

Матричные экраны, в отличие от семисегментных индикаторов, позволяют выводить полноценные текстовые символы, поэтому имеют дополнительные настройки.

Строка 
```
#define USE_RU_LANGUAGE
```
указывает, что для вывода дней недели и прочей информации будут использоваться символы кириллицы. Если вам это не нужно, закомментируйте эту строку, информация будет выводиться по английски.

Строка 
```
#define USE_TICKER_FOR_DATA
```
добавляет возможность анимировать вывод информации бегущей строкой; так же добавляется интерфейс для включения/отключения анимации, вход в настройки опции - длинный клик кнопкой **Down**.

Если закомментировать эту строку, то информация будет просто сменять друг друга.

Строка 
```
#define TICKER_SPEED 100
```
задает скорость бегущей строки в кадрах в секунду. 

Строка 
```
#define SHOW_SECOND_COLUMN
``` 
включает вывод в крайнем правом столбце экрана столбика светодиодов, отображающих количество прошедших секунд в минуте. Первые полминуты каждые пять секунд световой столбик увеличивается на один светодиод снизу вверх, со второй половины минуты световой столбик каждые пять секунд уменьшается на один светодиод снизу вверх.

### Блок "кнопки"

Здесь задаются параметры кнопок, которыми будут управляться часы.

Строка
```
#define BTN_INPUT_TYPE PULL_UP
```
определяет тип подключения кнопки (см. комментарий к строке с указанием возможных вариантов).

В строке 
```
#define BTN_TYPE BTN_NO
```
задается тип кнопки (так же см. комментарий к строке с указанием возможных вариантов).

Строки
```
uint16_t constexpr TIMEOUT_OF_LONGCLICK = 1000; 
uint16_t constexpr INTERVAL_OF_SERIAL = 100;    
uint16_t constexpr TIMEOUT_OF_DEBOUNCE = 50;    
uint16_t constexpr TIMEOUT_OF_DBLCLICK = 300;
```
задают настройки кнопок - интервал удержания кнопки нажатой, интервал выдачи событий **BTN_LONGCLICK** при удержании кнопки нажатой (используется для кнопок **Up** и **Down**), интервал антидребезга и интервал двойного клика соответственно. Все настройки задаются в милисекундах.

***Важно!!!** - интервал обновления интерфейсов настроек составляет 50 милисекунд, соответственно, минимальный интервал выдачи событий **BTN_LONGCLICK** может составлять именно 50 милисекунд; меньшее значение просто не будет успевать обрабатываться; поэтому значение `INTERVAL_OF_SERIAL` нужно задавать кратным 50, т.е. 50, 100, 150; если же задавать какие-то промежуточные значения, то возможна визуальная неравномерность изменения значений.*

Строка 
```
#define USE_BUZZER_FOR_BUTTON
```
определяет, будет ли озвучиваться каждый клик кнопки. Конечно, для этого в системе должна присутствовать пищалка, и должен быть определен пин, к которому она подключена.

Пины для подключения кнопок задаются в строках
```
int8_t constexpr BTN_SET_PIN = 4;
int8_t constexpr BTN_DOWN_PIN = 6;
int8_t constexpr BTN_UP_PIN = 9;
```
если какая-то из кнопок не будет использоваться, вместо номера можно задать -1.

### Блок "дополнительные опции"

#### Календарь

Строка
```
#define USE_CALENDAR
```
добавляет в часы функционал календаря. Вывод даты на экран выполняется кликом кнопкой **Down**. Дополнительно добавляется интерфейс для настройки текущей даты. В режим настройки даты часы переходят по короткому клику кнопкой **Set** из режима настройки минут или по длинному клику кнопкой **Set** из режима отбражения календаря.

#### Будильник

Строка
```
#define USE_ALARM
```
добавляет часам функционал будильника. Дополнительно добавляется интерфейс настройки будильника.

Строки
```
uint8_t constexpr ALARM_DURATION = 60;
uint8_t constexpr ALARM_SNOOZE_DELAY = 120;
uint8_t constexpr ALARM_REPETITION_COUNT = 3;
```
задают длительность сигнала будильника в секундах, задержку перед следующим срабатыванием в секундах, если сигнал не был отключен, и количество повторов сигнала. Т.е. если сигнал не отключать, то он сработает три раза по минуте с интервалом между срабатыванием в две минуты.

Строка
```
#define USE_ONECLICK_TO_SET_ALARM
```
позволяет входить в настройки будильника по однократному клику кнопкой **Set** вместо двойного клика, принятого по умолчанию.

Строка
```
int8_t constexpr ALARM_LED_PIN = 7;
```
задает пин для подключения светодиода-индикатора состояния будильника; если индикаторный светодиод использоваться не будет, можно задать для его пина значение -1.

#### Режим настройки уровней яркости

Строка
```
#define USE_SET_BRIGHTNESS_MODE
```
добавляет часам функционал регулировки яркости экрана. В этом случае при использовании датчика света можно будет настраивать как минимальный, так и максимальный уровни, иначе можно будет настроить только максимальный уровень яркости экрана.

Вход в режим настройки яркости выполняется по удержанию одновременно нажатыми кнопок **Up** и **Down**.

***Режим регулировки уровня яркости не доступен для LCD 1602/2004 экранов***

#### Вывод температуры

Строка
```
#define USE_TEMP_DATA
```
добавляет возможность выводить на экран температуру воздуха в помещении по клику кнопкой **Up**.

### Блок "пищалка"

Пищалка может использоваться как будильником, так и кнопками для озвучивания клика (например, если вы используете сенсорные кнопки). Пин для подключения пищалки задается строкой
```
int8_t constexpr BUZZER_PIN = 5; 
```

### Блок "датчики"

#### Датчик освещенности

Строка
```
#define USE_LIGHT_SENSOR
```
добавляет возможность автоматически снижать яркость экрана при низком освещении; так же добавляется интерфейс настройки порога переключения яркости экрана. Вход в режим настройки порога переключения яркости выполняется по удержанию одновременно нажатыми кнопок **Up** и **Down**.

Строка
```
int8_t constexpr LIGHT_SENSOR_PIN = A3; 
```
определяет аналоговый пин, к которому будет подключен датчик. Схему подключения датчика см. [здесь](light_sensor.md).

***Режим регулировки уровня яркости не доступен для LCD 1602/2004 экранов, поэтому настройки датчика освещенности для таких экранов не учитываются***

#### Датчики температуры

##### DS18B20

Строка
```
#define USE_DS18B20
```
позволяет использовать для вывода температуры датчик **DS18b20** и некоторые другие датчики из этой серии.

Строка
```
int8_t constexpr DS18B20_PIN = 8;
```
определяет пин, к которому подключается линия данных дачика

##### NTC термистор

Строка
```
#define USE_NTC
```
позволяет использовать в качестве датчика температуры NTC-термистор

Для использования термистора нужно знать его сопротивление при комнатной (25 градусов Цельсия) температуре и точное сопротивление второго резистора в делителе напряжения (и то, и другое - в Омах). Также нужно знать бета-коэффициент термистора - он отражает изменение сопротивления термистора при изменении температуры; значение коэффициента можно узнать у производителя датчика или рассчитать (см. описание в файле **ntc.h**). Все эти данные описываются в строках
```
uint16_t constexpr RESISTOR_STD = 10000;
uint16_t constexpr BALANCE_RESISTOR = 9850;
uint16_t constexpr BETA_COEFFICIENT = 3950;
```
соответственно.

Строка
```
int8_t constexpr NTC_PIN = A0; 
```
задает аналоговый пин, к которому подключается датчик.

Схемы подключения температурных датчиков см. [здесь](temp_sensors.md).

### Блок "прочие настройки"

Строка
```
#define AUTO_EXIT_TIMEOUT 6
```
задает время в секундах, по истечение которого часы возвращаются в режим показа времени из любого другого режима при отсутствии активности пользователя.

Строка
```
#define USE_CLOCK_EVENT
```
указывает, будут ли использоваться события часов - ежесекундное событие и событие будильника; если они не нужны, закомментируйте эту строку.

Строка
```
#define BIT_DEPTH 10 
```
задает разрядность АЦП вашего микроконтроллера; АЦП используется библиотекой для определения уровня освещенности и температуры при использовании NTC-термистора в качестве датчика температуры.

Строка имеет смысл при использовании хотя бы одной из опций `USE_LIGHT_SENSOR` или `USE_NTC`.


### Блок "настройки EEPROM"

```
#define SECOND_COLUMN_ON_OF_DATA_EEPROM_INDEX 94  
```
индекс ячейки в **EEPROM** для сохранения статуса секундного столбика (uint8_t); имеет смысл только для матричных экранов при использовании опции `SHOW_SECOND_COLUMN`;

```
#define INTERVAL_FOR_AUTOSHOWDATA_EEPROM_INDEX 96
```
индекс ячейки в **EEPROM** для сохранения интервала автовывода даты и/или температуры на экран (uint8_t); имеет смысл только при использовании одной из опций `USE_CALENDAR` или `USE_TEMP_DATA`.

```
#define TICKER_STATE_VALUE_EEPROM_INDEX 97  
```
индекс ячейки в **EEPROM** для сохранения статуса анимации (uint8_t); имеет смысл только при использовании опции `#define USE_TICKER_FOR_DATA`.

```
#define LIGHT_THRESHOLD_EEPROM_INDEX 95
```
индекс ячейки в **EEPROM** для сохранения порога переключения яркости экрана (uint8_t); имеет смысл только при использовании опции `USE_LIGHT_SENSOR`.

```
#define MIN_BRIGHTNESS_VALUE_EEPROM_INDEX 98 
```
индекс ячейки в **EEPROM** для сохранения  минимального значения яркости экрана (uint8_t); так же имеет смысл только при использовании датчика освещенности.

```
#define MAX_BRIGHTNESS_VALUE_EEPROM_INDEX 99
```
индекс ячейки в **EEPROM** для сохранения  максимального значение яркости экрана (uint8_t).

```
#define ALARM_DATA_EEPROM_INDEX 100
```
индекс первой ячейки в **EEPROM** для сохранения настроек будильника (uint8_t + uint16_t); занимает три ячейки; имеет смысл только при использовании будильника.

```
#define COLOR_OF_NUMBER_VALUE_EEPROM_INDEX 103
```
индекс первой ячейки в **EEPROM** для сохранения цвета символов экрана (uint8_t x 4); занимает четыре ячейки; имеет смысл только при использовании экранов, составленных из адресных светодиодов.

```
#define COLOR_OF_BACKGROUND_VALUE_EEPROM_INDEX 107
```
индекс первой ячейки в **EEPROM** для сохранения цвета фона экрана (uint8_t x 4); занимает четыре ячейки; имеет смысл только при использовании экранов, составленных из адресных светодиодов.


### Блок "модуль RTC"

Строка 
```
#define RTC_DS3231
```
задает тип используемого модуля. Возможные варианты указаны в комментарии к строке:
```
RTC_DS3231 - модуль DS3231
RTC_DS1307 - модуль DS1307
RTC_PCF8523 - модуль PCF8523
RTC_PCF8563 - модуль PCF8563
``` 

Пины для подключения указаны для информации, в коде они нигде не используются. Модули работают через аппаратный **I2C** микроконтроллера, соответственно, к пинам аппаратного **I2C** выбранного МК их и нужно подключать.


<hr>

### Смотри так же
- [Главная страница](../readme.md)
- [Используемые модули RTC](rtc.md)
- [Используемые в часах экраны](displays.md)
- [Управление часами - кнопки](buttons.md)
- Дополнительные опции:
  - [Календарь](calendar.md)
  - [Будильник](alarm.md)
  - [Регулировка уровней яркости экрана](br_adjust.md)
  - [Отображение температуры](show_temp.md)
  - [Опции для матричных экранов](matrix.md)
- Внешние датчики:
  - [Датчик освещенности](light_sensor.md)
  - [Датчики температуры](temp_sensors.md)
- [Взаимодействие с внешним кодом (API библиотеки)](api.md)
- [Руководство по настройкам часов](setting.md)
